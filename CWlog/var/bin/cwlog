#!/bin/sh
#################################################################################
#
# CWlog  control word logger
#
# CWLog reads the /tmp/ecm.info file repeatedly and writes the CWs to 
# a CWL file for offline decryption.
#
# History:
#
# V1.1   17.12.08    replacement of CWx: case insensitive
# V1.0   07.12.08    initial release
#
#################################################################################

VER='CWlog V1.1' 

IN="/tmp/ecm.info" 
OUT_PRE="/tmp/"
OUT_POST=".cwl" 
POLLTIME=1   


LINE1=""
FROM=""
CW0=""
CW1=""
LASTLINE1=""
LASTCW0=""
LASTCW1=""
TIMEPOSIX=""
LASTTIMEPOSIX=-1
SECDELTA=""

echo $VER": logging started"

while [ 1 ]
do
   if [ -e $IN ] ; then
      # access to $IN file is not atomic (yet)
      LINE1=`sed -e '1qd' <$IN`
      CW0=`sed -e '3qd' <$IN`
      CW1=`sed -e '4qd' <$IN`

      if [ "$LASTLINE1" != "$LINE1" ] ; then
         # 1st line of ecm.info has changed, we start a new logging file now
         wget -O /tmp/mylist http://127.0.0.1/control/channellist   2>/dev/null
         wget -O /tmp/mych http://127.0.0.1/control/zapto           2>/dev/null
         read myid < /tmp/mych
         grep $myid /tmp/mylist > /tmp/mypair
         read junk CHANNEL < /tmp/mypair
         rm /tmp/mypair
         rm /tmp/mych
         rm /tmp/mylist

         #calculate new cwl file name
         DATTIM=`date +"%y%m%d_%H%M%S_"`
         OUT="$OUT_PRE$DATTIM$CHANNEL$OUT_POST"
         
         LASTLINE1=$LINE1
         LASTCW0=""
         LASTCW1=""
         LASTTIMEPOSIX=-1
         date +"# $VER - logging of $CHANNEL started at: %D %T"  >>$OUT
         echo "# $LINE1"  >>$OUT
      fi
      
      if [ "$LASTCW0" != "$CW0" ] || [ "$LASTCW1" != "$CW1" ] ; then
         TIMEPOSIX=`date +"%s"`
         if [ "$LASTTIMEPOSIX" != -1 ] ; then
            SECDELTA=`expr $TIMEPOSIX - $LASTTIMEPOSIX`
         else
            SECDELTA=""
         fi
         LASTTIMEPOSIX=$TIMEPOSIX
        
         if [ "$LASTCW0" != "$CW0" ] ; then
            #echo "new CW0 detected"
            LASTCW0=$CW0
            CW0=`echo $CW0|sed s/CW0:/0/I`
            date +"$CW0 # %T $SECDELTA"  >>$OUT  # this is current time and not time of $IN
         fi
         if [ "$LASTCW1" != "$CW1" ]  ; then
            #echo "new CW1 detected"
            LASTCW1=$CW1
            CW1=`echo $CW1|sed s/CW1:/1/I`
            date +"$CW1 # %T $SECDELTA"  >>$OUT  # this is current time and not time of $IN
         fi
      fi # CW0 or CW1 changed
   fi # if [ -e $IN ]
   sleep $POLLTIME
done    # while
   
